<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4、Map 底层原理 | TechTalks</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/image/ico.png">
    <meta name="description" content="TechTalks：提高你的编程技能和思维方式的计算机技术博客">
    <meta name="baidu-site-verification" content="codeva-ykKwcuuoe9">
    
    <link rel="preload" href="/assets/css/0.styles.576f4a24.css" as="style"><link rel="preload" href="/assets/js/app.fc9a0fee.js" as="script"><link rel="preload" href="/assets/js/2.23b0dd23.js" as="script"><link rel="preload" href="/assets/js/37.d09ba391.js" as="script"><link rel="prefetch" href="/assets/js/10.a98a493f.js"><link rel="prefetch" href="/assets/js/11.2a2aacd9.js"><link rel="prefetch" href="/assets/js/12.3d0f3174.js"><link rel="prefetch" href="/assets/js/13.d1963436.js"><link rel="prefetch" href="/assets/js/14.77342273.js"><link rel="prefetch" href="/assets/js/15.cbb8a1bc.js"><link rel="prefetch" href="/assets/js/16.778032f2.js"><link rel="prefetch" href="/assets/js/17.7f3894c5.js"><link rel="prefetch" href="/assets/js/18.ac3d35a1.js"><link rel="prefetch" href="/assets/js/19.959b70d4.js"><link rel="prefetch" href="/assets/js/20.215bd659.js"><link rel="prefetch" href="/assets/js/21.a96c9215.js"><link rel="prefetch" href="/assets/js/22.43268ef2.js"><link rel="prefetch" href="/assets/js/23.8e42e1d9.js"><link rel="prefetch" href="/assets/js/24.06232950.js"><link rel="prefetch" href="/assets/js/25.9052d76a.js"><link rel="prefetch" href="/assets/js/26.695293c1.js"><link rel="prefetch" href="/assets/js/27.706feac3.js"><link rel="prefetch" href="/assets/js/28.1d0df8ff.js"><link rel="prefetch" href="/assets/js/29.d46281bf.js"><link rel="prefetch" href="/assets/js/3.d987e878.js"><link rel="prefetch" href="/assets/js/30.a5747d2a.js"><link rel="prefetch" href="/assets/js/31.d62c7bc6.js"><link rel="prefetch" href="/assets/js/32.b174766b.js"><link rel="prefetch" href="/assets/js/33.ce24b614.js"><link rel="prefetch" href="/assets/js/34.ccfaec54.js"><link rel="prefetch" href="/assets/js/35.5904cdd0.js"><link rel="prefetch" href="/assets/js/36.4d73e5f3.js"><link rel="prefetch" href="/assets/js/38.02bebce0.js"><link rel="prefetch" href="/assets/js/39.6fb3035d.js"><link rel="prefetch" href="/assets/js/4.dd3b88fa.js"><link rel="prefetch" href="/assets/js/40.af1fe5d0.js"><link rel="prefetch" href="/assets/js/41.a6f1e36b.js"><link rel="prefetch" href="/assets/js/42.445356e8.js"><link rel="prefetch" href="/assets/js/5.18918da4.js"><link rel="prefetch" href="/assets/js/6.0b646984.js"><link rel="prefetch" href="/assets/js/7.8130c412.js"><link rel="prefetch" href="/assets/js/8.d6e6ea83.js"><link rel="prefetch" href="/assets/js/9.e09ec003.js">
    <link rel="stylesheet" href="/assets/css/0.styles.576f4a24.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://i.ibb.co/Dwq0gdg/ico.png" alt="TechTalks" class="logo"> <span class="site-name can-hide">TechTalks</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云原生" class="dropdown-title"><span class="title">云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="云原生" class="mobile-dropdown-title"><span class="title">云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud/blog/" class="nav-link">
  优秀博文
</a></li><li class="dropdown-item"><!----> <a href="/cloud/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用工具" class="dropdown-title"><span class="title">常用工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用工具" class="mobile-dropdown-title"><span class="title">常用工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/usual_tech/go/" class="nav-link router-link-active">
  Go
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/git/" class="nav-link">
  Git
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  快意门
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="八股文" class="dropdown-title"><span class="title">八股文</span> <span class="arrow down"></span></button> <button type="button" aria-label="八股文" class="mobile-dropdown-title"><span class="title">八股文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/cs/1/" class="nav-link">
  软件工程
</a></li><li class="dropdown-item"><!----> <a href="/cs/2/" class="nav-link">
  组成原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/browser/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/cs/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/go/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/go/cs/redis/" class="nav-link">
  Redis
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云原生" class="dropdown-title"><span class="title">云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="云原生" class="mobile-dropdown-title"><span class="title">云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud/blog/" class="nav-link">
  优秀博文
</a></li><li class="dropdown-item"><!----> <a href="/cloud/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用工具" class="dropdown-title"><span class="title">常用工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用工具" class="mobile-dropdown-title"><span class="title">常用工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/usual_tech/go/" class="nav-link router-link-active">
  Go
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/git/" class="nav-link">
  Git
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  快意门
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="八股文" class="dropdown-title"><span class="title">八股文</span> <span class="arrow down"></span></button> <button type="button" aria-label="八股文" class="mobile-dropdown-title"><span class="title">八股文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/cs/1/" class="nav-link">
  软件工程
</a></li><li class="dropdown-item"><!----> <a href="/cs/2/" class="nav-link">
  组成原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/browser/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/cs/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/go/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/usual_tech/go/cs/redis/" class="nav-link">
  Redis
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>一、基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>二、高阶知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/usual_tech/go/GMP.html" class="sidebar-link">1、GMP模型</a></li><li><a href="/usual_tech/go/GC.html" class="sidebar-link">2、 GO GC 垃圾回收机制</a></li><li><a href="/usual_tech/go/Slice.html" class="sidebar-link">3、 Slice 底层原理</a></li><li><a href="/usual_tech/go/Map.html" aria-current="page" class="active sidebar-link">4、Map 底层原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#_4-1-map-的底层内存模型" class="sidebar-link">4.1 Map 的底层内存模型</a></li><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#_4-2-map-的存与取" class="sidebar-link">4.2 Map 的存与取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#底层代码" class="sidebar-link">底层代码</a></li><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#寻址过程" class="sidebar-link">寻址过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#_4-3-map-的扩容" class="sidebar-link">4.3 Map 的扩容</a></li><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#_4-4-map-的有序性" class="sidebar-link">4.4 Map 的有序性</a></li><li class="sidebar-sub-header"><a href="/usual_tech/go/Map.html#_4-5-map-的并发" class="sidebar-link">4.5 Map 的并发</a></li></ul></li><li><a href="/usual_tech/go/mem.html" class="sidebar-link">5、Golang 的内存分配逃逸 堆和栈</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4、map-底层原理"><a href="#_4、map-底层原理" class="header-anchor">#</a> 4、Map 底层原理</h1> <blockquote><p>原文链接：https://mp.weixin.qq.com/s/UT8tydajjOUJkfc-Brcblw</p></blockquote> <h2 id="_4-1-map-的底层内存模型"><a href="#_4-1-map-的底层内存模型" class="header-anchor">#</a> 4.1 Map 的底层内存模型</h2> <p>在 golang 的源码中表示 map 的底层 struct 是 hmap，其是 hashmap 的缩写</p> <div class="language-Go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>

   <span class="token comment">// map中存入元素的个数， golang中调用len(map)的时候直接返回该字段</span>
   count     <span class="token builtin">int</span>
   <span class="token comment">// 状态标记位，通过与定义的枚举值进行&amp;操作可以判断当前是否处于这种状态</span>
   flags     <span class="token builtin">uint8</span>
   B         <span class="token builtin">uint8</span>  <span class="token comment">// 2^B 表示bucket的数量， B 表示取hash后多少位来做bucket的分组</span>
   noverflow <span class="token builtin">uint16</span> <span class="token comment">// overflow bucket 的数量的近似数</span>
   hash0     <span class="token builtin">uint32</span> <span class="token comment">// hash seed （hash 种子） 一般是一个素数</span>

   buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 共有2^B个 bucket ，但是如果没有元素存入，这个字段可能为nil</span>
   oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 在扩容期间，将旧的bucket数组放在这里， 新buckets会是这个的两倍大</span>
   nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// 表示已经完成扩容迁移的bucket的指针， 地址小于当前指针的bucket已经迁移完成</span>

   extra <span class="token operator">*</span>mapextra <span class="token comment">// optional fields</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>B 是 buckets 数组的长度的对数， 即 bucket 数组的长度是 2^B。bucket 的本质上是一个指针，指向了一片内存空间，其指向的 struct 如下所示：</p> <div class="language-Go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// A bucket for a Go map.</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但这只是表面(src/runtime/hashmap.go)的结构，编译期间会给它加料，动态地创建一个新的结构：</p> <div class="language-Go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    topbits  <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
    keys     <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>keytype
    values   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>valuetype
    pad      <span class="token builtin">uintptr</span>        <span class="token comment">// 内存对齐使用，可能不需要</span>
    overflow <span class="token builtin">uintptr</span>        <span class="token comment">// 当bucket 的8个key 存满了之后</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>bmap 就是我们常说的“桶”的底层数据结构， 一个桶中可以存放最多 8 个 key/value, map 使用 hash 函数 得到 hash 值决定分配到哪个桶， 然后又会根据 hash 值的高 8 位来寻找放在桶的哪个位置 具体的 map 的组成结构如下图所示：
<img src="/image/usual_tech/go/bmap.jpeg" alt="bmap"></p> <h2 id="_4-2-map-的存与取"><a href="#_4-2-map-的存与取" class="header-anchor">#</a> 4.2 Map 的存与取</h2> <p>在 map 中存与取本质上都是在进行一个工作， 那就是:</p> <ol><li>查询当前 k/v 应该存储的位置。</li> <li>赋值/取值， 所以我们理解了 map 中 key 的定位我们就理解了存取。</li></ol> <h3 id="底层代码"><a href="#底层代码" class="header-anchor">#</a> 底层代码</h3> <div class="language-Go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccess2</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// map 为空，或者元素数为 0，直接返回未找到</span>
    <span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不支持并发读写</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map read and map write&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据hash 函数算出hash值，注意key的类型不同可能使用的hash函数也不同</span>
    hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果 B = 5，那么结果用二进制表示就是 11111 ， 返回的是B位全1的值</span>
    m <span class="token operator">:=</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
    <span class="token comment">// 根据hash的后B位，定位在bucket数组中的位置</span>
    b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 当 h.oldbuckets 非空时，说明 map 发生了扩容</span>
    <span class="token comment">// 这时候，新的 buckets 里可能还没有老的内容</span>
    <span class="token comment">// 所以一定要在老的里面找，否则有可能发生“消失”的诡异现象</span>
    <span class="token keyword">if</span> c <span class="token operator">:=</span> h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明之前只有一半的 bucket，需要除 2</span>
            m <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        oldb <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">evacuated</span><span class="token punctuation">(</span>oldb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> oldb
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// tophash 取其高 8bit 的值</span>
    top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
    <span class="token comment">// 一个 bucket 在存储满 8 个元素后，就再也放不下了，这时候会创建新的 bucket，挂在原来的 bucket 的 overflow 指针成员上</span>
    <span class="token comment">// 遍历当前bucket的所有链式bucket</span>
    <span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在bucket的8个位置上查询</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果找到了相等的 tophash，那说明就是这个 bucket 了</span>
            <span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 根据内存结构定位key的位置</span>
            k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> t<span class="token punctuation">.</span>indirectkey <span class="token punctuation">{</span>
                k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 校验找到的key是否匹配</span>
            <span class="token keyword">if</span> t<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 定位v的位置</span>
                v <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>valuesize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> t<span class="token punctuation">.</span>indirectvalue <span class="token punctuation">{</span>
                    v <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> v<span class="token punctuation">,</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 所有 bucket 都没有找到，返回零值和 false</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="寻址过程"><a href="#寻址过程" class="header-anchor">#</a> 寻址过程</h3> <p><img src="/image/usual_tech/go/mapadd.png" alt="mapadd"> <img src="/image/usual_tech/go/mapfor.png" alt="mapfor"></p> <h2 id="_4-3-map-的扩容"><a href="#_4-3-map-的扩容" class="header-anchor">#</a> 4.3 Map 的扩容</h2> <p>在 golang 中 map 和 slice 一样都是在初始化时首先申请较小的内存空间，在 map 的不断存入的过程中，动态的进行扩容。扩容共有两种，<strong><em>增量扩容与等量扩容</em></strong>（重新排列并分配内存）。下面我们来了解一下扩容的触发方式：</p> <ol><li>负载因子超过阈值，源码里定义的阈值是 6.5。(触发增量扩容)</li> <li>overflow 的 bucket 数量过多：当 B 小于 15，也就是 bucket 总数 2^B 小于 2^15 时，如果 overflow 的 bucket 数量超过 2^B；当 B &gt;= 15，也就是 bucket 总数 2^B 大于等于 2^15，如果 overflow 的 bucket 数量超过 2^15。（触发等量扩容）</li></ol> <h2 id="_4-4-map-的有序性"><a href="#_4-4-map-的有序性" class="header-anchor">#</a> 4.4 Map 的有序性</h2> <p>先说结论，在 golang 中 map 是无序的，准确的说是无法严格保证顺序的， 从上面的源码中我们可以知道，golang 中 map 在扩容后，可能会将部分 key 移至新内存，由于在扩容搬移数据过程中，并未记录原数据位置， 并且在 golang 的数据结构中也并未保存数据的顺序，所以那么这一部分在扩容后实际上就已经是无序的了。
遍历的过程，其实就是按顺序遍历内存地址，同时按顺序遍历内存地址中的 key。但这时已经是无序的了。但是如果我就一个 map，我保证不会对 map 进行修改删除等操作，那么按理说没有扩容就不会发生改变。但也是因为这样，GO 才在源码中 但是有一个有趣的现象，就算不对 map 进行插入删除等操作致使其扩容，其在遍历过程中仍是无序的。</p> <div class="language-Go line-numbers-mode"><pre class="language-go"><code>objMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
   objMap<span class="token punctuation">[</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> i
<span class="token punctuation">}</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> valStr1<span class="token punctuation">,</span> valStr2 <span class="token builtin">string</span>
   <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> objMap <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
      valStr1 <span class="token operator">+=</span> k
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> objMap <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
      valStr2 <span class="token operator">+=</span> k
   <span class="token punctuation">}</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>valStr1 <span class="token operator">==</span> valStr2<span class="token punctuation">)</span>
   <span class="token keyword">if</span> valStr1 <span class="token operator">!=</span> valStr2 <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;not equal&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>以上的运行结果是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>not equal
equal
not equal
not equal
not equal
equal
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>不难看出，即使不对 map 进行扩容，在多次遍历时也是无序的，这是因为 golang 官方在设计时故意加上随机的元素，将遍历 map 的顺序随机化，用来防止使用者用来顺序遍历。
依赖 map 的顺序进行遍历，这是有风险的代码，在 GO 的严格语法规则下，是坚决不提倡的。所以我们在使用 map 时一定要记得其是无序的，不要依赖其顺序。</p> <h2 id="_4-5-map-的并发"><a href="#_4-5-map-的并发" class="header-anchor">#</a> 4.5 Map 的并发</h2> <p>首先我们大家都知道，在 golang 中 map 并不是一个并发安全的数据结构，当几个 goruotine 同时对一个 map 进行读写操作时，就会出现并发写问题：fatal error: concurrent map writes。但是为什么 map 是不支持并发安全的呢， 主要是因为成本与效益。
官方答复原因如下：</p> <ul><li>典型使用场景：map 的典型使用场景是不需要从多个 goroutine 中进行安全访问。</li> <li>非典型场景（需要原子操作）：map 可能是一些更大的数据结构或已经同步的计算的一部分。
性能场景考虑：若是只是为少数程序增加安全性，导致 map 所有的操作都要处理 mutex，将会降低大多数程序的性能。同时 golang 提供了并发安全的 sync map。</li></ul> <div class="language-Go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 不支持并发读写</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map read and map write&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是我们又有疑问了，为什么 golang map 并发冲突了不抛一个 error 出来，或者 panic 掉，而是要让程序 panic，选择让程序 crash 崩溃掉。这里是 golang 官方出于权衡风险和 map 使用复杂度场景考虑的，首先 map 在官方中就明确表示不支持并发读写， 所以并发对 map 进行读写操作本身就是不正确的。
场景假设一：如果 map 选择在写入或者读取时增加 error 返回值，会导致程序在使用 map 时就无法像现在一样，需要额外的捕获并判断 err。
场景假设二：如果 map 选择 panic（可被 recover），此时如果出现并发写入数据的场景，就会导致走进 recover 中，如果没有对这种场景进行特殊处理，就会导致 map 中存在脏数据，此时程序在使用 map 时就会引发不可预知的错误，此时排查起来也是很难找到问题的根因的。
所以 golang 在考虑了这些场景后，选择明确的抛出 crash 崩溃异常，使得风险被提前暴露。可以明确的定位到问题点。综上所述我们在使用 map 时，已经要严格保障其是在单线程内使用的，如果有多线程场景，建议使用 sync map 。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usual_tech/go/Slice.html" class="prev">
        3、 Slice 底层原理
      </a></span> <span class="next"><a href="/usual_tech/go/mem.html">
        5、Golang 的内存分配逃逸 堆和栈
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc9a0fee.js" defer></script><script src="/assets/js/2.23b0dd23.js" defer></script><script src="/assets/js/37.d09ba391.js" defer></script>
  </body>
</html>
